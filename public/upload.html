<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‚¬ì§„ ì—…ë¡œë“œ - Rewrite Moment</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¬</text></svg>">
</head>
<body>
  <div class="bg-pattern"></div>
  <div class="noise-overlay"></div>

  <!-- Navigation -->
  <nav class="nav">
    <div class="container nav-inner">
      <a href="index.html" class="nav-logo">
        <div class="nav-logo-icon">ğŸ¬</div>
        <span class="nav-logo-text">Rewrite Moment</span>
      </a>
      <ul class="nav-links">
        <li><a href="index.html#features" class="nav-link">ê¸°ëŠ¥</a></li>
        <li><a href="index.html#how" class="nav-link">ì´ìš©ë°©ë²•</a></li>
        <li><a href="pricing.html" class="nav-link">ê°€ê²©</a></li>
      </ul>
      <div class="nav-auth">
        <div class="nav-credits">
          <span class="nav-credits-icon">ğŸ’</span>
          <span class="nav-credits-value" id="nav-credits">0</span>
          <span style="color: var(--text-muted)">í¬ë ˆë”§</span>
        </div>
        <button class="btn-login" id="btn-open-login" onclick="openAuthModal('login')">ë¡œê·¸ì¸</button>
        <div class="user-menu hidden" id="user-menu">
          <div class="user-avatar" id="user-avatar" onclick="toggleUserDropdown()">U</div>
          <div class="user-dropdown" id="user-dropdown">
            <div class="user-dropdown-header">
              <div class="user-dropdown-name" id="user-name">ì‚¬ìš©ì</div>
              <div class="user-dropdown-email" id="user-email">user@email.com</div>
            </div>
            <div class="user-dropdown-menu">
              <a href="pricing.html" class="user-dropdown-item">ğŸ’ í¬ë ˆë”§ ì¶©ì „</a>
              <a href="#" class="user-dropdown-item">ğŸ“‹ ë‚´ ì˜ìƒ</a>
              <div class="user-dropdown-item logout" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="page" style="padding-top: 100px;">
    <div class="container container-sm">
      
      <!-- Progress Steps -->
      <div class="steps">
        <div class="step active">
          <div class="step-number">1</div>
          <span class="step-text">ì—…ë¡œë“œ</span>
        </div>
        <div class="step-line"></div>
        <div class="step">
          <div class="step-number">2</div>
          <span class="step-text">ì„¤ì •</span>
        </div>
        <div class="step-line"></div>
        <div class="step">
          <div class="step-number">3</div>
          <span class="step-text">ìƒì„±</span>
        </div>
        <div class="step-line"></div>
        <div class="step">
          <div class="step-number">4</div>
          <span class="step-text">ê²°ê³¼</span>
        </div>
      </div>

      <!-- Page Header -->
      <div class="page-header" data-animate>
        <h1 class="page-title">
          <span class="text-gradient">ì‚¬ì§„ 2ì¥</span>ìœ¼ë¡œ<br>
          í•¨ê»˜í•˜ëŠ” ì˜ìƒ ë§Œë“¤ê¸°
        </h1>
        <p class="page-subtitle">
          ë‚´ ì‚¬ì§„ê³¼ í•¨ê»˜í•˜ê³  ì‹¶ì€ ì‚¬ëŒì˜ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.<br>
          AIê°€ ë‘ ì‚¬ëŒì´ í•¨ê»˜í•˜ëŠ” ì˜ìƒì„ ë§Œë“¤ì–´ë“œë ¤ìš”!
        </p>
      </div>

      <!-- Upload Cards -->
      <div class="upload-cards" data-animate style="animation-delay: 0.1s">
        
        <!-- ë‚´ ì‚¬ì§„ ì—…ë¡œë“œ -->
        <div class="upload-card">
          <div class="upload-card-header">
            <span class="upload-card-icon">ğŸ‘¤</span>
            <h3>ë‚´ ì‚¬ì§„</h3>
          </div>
          <div class="upload-zone" id="uploadZone1">
            <input type="file" id="fileInput1" accept="image/jpeg,image/png,image/webp">
            <div class="upload-icon">ğŸ“¸</div>
            <p class="upload-desc">ë‚´ ì–¼êµ´ì´ ì˜ ë³´ì´ëŠ” ì‚¬ì§„</p>
          </div>
          <div class="preview-box" id="preview1"></div>
        </div>

        <!-- ë°°ìš° ì‚¬ì§„ ì—…ë¡œë“œ -->
        <div class="upload-card">
          <div class="upload-card-header">
            <span class="upload-card-icon">â­</span>
            <h3>í•¨ê»˜í•  ì‚¬ëŒ ì‚¬ì§„</h3>
          </div>
          <div class="upload-zone" id="uploadZone2">
            <input type="file" id="fileInput2" accept="image/jpeg,image/png,image/webp">
            <div class="upload-icon">ğŸ¬</div>
            <p class="upload-desc">ë°°ìš°, ìœ ëª…ì¸, ì¹œêµ¬ ë“±</p>
          </div>
          <div class="preview-box" id="preview2"></div>
        </div>

      </div>

      <!-- Tips -->
      <div class="card mt-lg" data-animate style="animation-delay: 0.15s">
        <div class="upload-tips">
          <h4 style="font-size: 0.95rem; margin-bottom: 12px; color: var(--text-secondary);">
            ğŸ’¡ ì¢‹ì€ ì‚¬ì§„ íŒ
          </h4>
          <div class="tips-grid">
            <div class="tip-item tip-good">
              <span class="tip-icon">âœ“</span>
              <span>ì–¼êµ´ì´ í¬ê²Œ ì˜ ë³´ì´ëŠ” ì‚¬ì§„</span>
            </div>
            <div class="tip-item tip-good">
              <span class="tip-icon">âœ“</span>
              <span>ë°ì€ ì¡°ëª…ì˜ ì„ ëª…í•œ ì‚¬ì§„</span>
            </div>
            <div class="tip-item tip-bad">
              <span class="tip-icon">âœ—</span>
              <span>ì„ ê¸€ë¼ìŠ¤/ë§ˆìŠ¤í¬ ì°©ìš©</span>
            </div>
            <div class="tip-item tip-bad">
              <span class="tip-icon">âœ—</span>
              <span>íë¦¿í•˜ê±°ë‚˜ ì‘ì€ ì–¼êµ´</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Consent -->
      <div class="consent-card mt-lg" data-animate style="animation-delay: 0.2s">
        <label class="form-check">
          <input type="checkbox" class="form-check-input" id="consent1">
          <span class="form-check-label">
            ì—…ë¡œë“œí•˜ëŠ” ì‚¬ì§„ì€ ë³¸ì¸ ë˜ëŠ” ì •ë‹¹í•œ ê¶Œë¦¬ê°€ ìˆëŠ” ì‚¬ì§„ì…ë‹ˆë‹¤.
          </span>
        </label>
        <label class="form-check mt-md">
          <input type="checkbox" class="form-check-input" id="consent2">
          <span class="form-check-label">
            ê²°ê³¼ë¬¼ì€ <strong>ê°€ìƒì˜ ì°½ì‘ë¬¼</strong>ì´ë©° ì˜ˆì¸¡ì´ë‚˜ ì‚¬ì‹¤ì´ ì•„ë‹˜ì„ ì´í•´í•©ë‹ˆë‹¤.
          </span>
        </label>
      </div>

      <!-- Actions -->
      <div class="actions-row mt-xl" data-animate style="animation-delay: 0.3s">
        <a href="index.html" class="btn btn-ghost">
          â† ëŒì•„ê°€ê¸°
        </a>
        <button class="btn btn-primary btn-lg" id="nextBtn" disabled>
          ë‹¤ìŒ ë‹¨ê³„ë¡œ
          <span>â†’</span>
        </button>
      </div>

      <!-- Disclaimer -->
      <div class="disclaimer mt-xl" data-animate style="animation-delay: 0.4s">
        <strong>ì•ˆë‚´:</strong> ì—…ë¡œë“œëœ ì‚¬ì§„ì€ ì˜ìƒ ìƒì„± ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë˜ë©°, 
        ìƒì„± ì™„ë£Œ í›„ ì„œë²„ì—ì„œ ì‚­ì œë©ë‹ˆë‹¤.
      </div>

    </div>
  </main>

  <script src="/js/app.js"></script>
  <style>
    .page-title {
      font-size: 2.25rem;
    }

    .upload-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .upload-card {
      background: var(--bg-secondary);
      border: var(--border-subtle);
      border-radius: var(--radius-xl);
      padding: 24px;
    }

    .upload-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .upload-card-icon {
      font-size: 1.5rem;
    }

    .upload-card h3 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .upload-zone {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-lg);
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .upload-zone:hover {
      border-color: var(--accent-primary);
      background: rgba(168, 85, 247, 0.05);
    }

    .upload-zone.drag-over {
      border-color: var(--accent-primary);
      background: rgba(168, 85, 247, 0.1);
    }

    .upload-zone.has-image {
      display: none;
    }

    .upload-zone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .upload-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .upload-desc {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .preview-box {
      display: none;
      position: relative;
    }

    .preview-box.has-image {
      display: block;
    }

    .preview-box img {
      width: 100%;
      border-radius: var(--radius-lg);
      aspect-ratio: 1;
      object-fit: cover;
    }

    .preview-remove {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .preview-remove:hover {
      background: var(--error);
    }

    .upload-tips {
      padding: 20px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: var(--radius-md);
    }

    .tips-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .tip-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.85rem;
      color: var(--text-tertiary);
    }

    .tip-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 0.7rem;
      flex-shrink: 0;
    }

    .tip-good .tip-icon {
      background: rgba(74, 222, 128, 0.15);
      color: var(--success);
    }

    .tip-bad .tip-icon {
      background: rgba(248, 113, 113, 0.15);
      color: var(--error);
    }

    .consent-card {
      padding: 20px;
      background: var(--bg-secondary);
      border: var(--border-subtle);
      border-radius: var(--radius-lg);
    }

    .consent-card strong {
      color: var(--accent-primary);
    }

    .actions-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    @media (max-width: 768px) {
      .page-title {
        font-size: 1.5rem;
        line-height: 1.3;
      }

      .page-subtitle {
        font-size: 0.9rem;
      }

      .page-subtitle br {
        display: none;
      }

      .upload-cards {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .upload-card {
        padding: 16px;
      }

      .upload-card h3 {
        font-size: 1rem;
      }

      .upload-zone {
        padding: 30px 16px;
      }

      .upload-icon {
        font-size: 2.5rem;
      }

      .upload-desc {
        font-size: 0.85rem;
      }

      .tips-grid {
        grid-template-columns: 1fr;
      }

      .tip-item {
        font-size: 0.8rem;
      }

      .consent-card {
        padding: 16px;
      }

      .form-check-label {
        font-size: 0.85rem;
      }

      .actions-row {
        flex-direction: column;
        gap: 12px;
      }

      .actions-row .btn {
        width: 100%;
      }

      .disclaimer {
        font-size: 0.8rem;
        text-align: center;
      }
    }
  </style>
  <script>
    // ì—…ë¡œë“œ ê´€ë ¨ ìš”ì†Œ
    const uploadZone1 = document.getElementById('uploadZone1');
    const uploadZone2 = document.getElementById('uploadZone2');
    const fileInput1 = document.getElementById('fileInput1');
    const fileInput2 = document.getElementById('fileInput2');
    const preview1 = document.getElementById('preview1');
    const preview2 = document.getElementById('preview2');
    const nextBtn = document.getElementById('nextBtn');
    const consent1 = document.getElementById('consent1');
    const consent2 = document.getElementById('consent2');

    let myPhoto = null;
    let actorPhoto = null;

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    [uploadZone1, uploadZone2].forEach((zone, index) => {
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('drag-over');
      });

      zone.addEventListener('dragleave', () => {
        zone.classList.remove('drag-over');
      });

      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file, index);
      });
    });

    // íŒŒì¼ ì„ íƒ
    fileInput1.addEventListener('change', (e) => {
      if (e.target.files[0]) handleFile(e.target.files[0], 0);
    });

    fileInput2.addEventListener('change', (e) => {
      if (e.target.files[0]) handleFile(e.target.files[0], 1);
    });

    // ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜ (sessionStorage ìš©ëŸ‰ ì œí•œ ëŒ€ì‘)
    function compressImage(file, maxWidth = 1024, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // ìµœëŒ€ ë„ˆë¹„ ì œí•œ
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            const compressedData = canvas.toDataURL('image/jpeg', quality);
            console.log('Image compressed:', Math.round(compressedData.length / 1024) + 'KB');
            resolve(compressedData);
          };
          img.onerror = () => reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
          img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
        reader.readAsDataURL(file);
      });
    }

    async function handleFile(file, index) {
      const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
      const maxSize = 10 * 1024 * 1024;

      if (!validTypes.includes(file.type)) {
        alert('JPG, PNG, WEBP ì´ë¯¸ì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }

      if (file.size > maxSize) {
        alert('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      try {
        // ì´ë¯¸ì§€ ì••ì¶•í•´ì„œ sessionStorage ìš©ëŸ‰ ë¬¸ì œ í•´ê²°
        const imageData = await compressImage(file);
        
        if (index === 0) {
          myPhoto = imageData;
          showPreview(preview1, uploadZone1, imageData, 0);
        } else {
          actorPhoto = imageData;
          showPreview(preview2, uploadZone2, imageData, 1);
        }
        
        checkCanProceed();
      } catch (error) {
        console.error('Image processing error:', error);
        alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    function showPreview(previewEl, zoneEl, imageData, index) {
      previewEl.innerHTML = `
        <img src="${imageData}" alt="Preview">
        <button class="preview-remove" onclick="removeImage(${index})">Ã—</button>
      `;
      previewEl.classList.add('has-image');
      zoneEl.classList.add('has-image');
    }

    function removeImage(index) {
      if (index === 0) {
        myPhoto = null;
        preview1.classList.remove('has-image');
        uploadZone1.classList.remove('has-image');
        fileInput1.value = '';
      } else {
        actorPhoto = null;
        preview2.classList.remove('has-image');
        uploadZone2.classList.remove('has-image');
        fileInput2.value = '';
      }
      checkCanProceed();
    }

    window.removeImage = removeImage;

    function checkCanProceed() {
      const hasPhotos = myPhoto && actorPhoto;
      const hasConsent = consent1.checked && consent2.checked;
      nextBtn.disabled = !(hasPhotos && hasConsent);
    }

    consent1.addEventListener('change', checkCanProceed);
    consent2.addEventListener('change', checkCanProceed);

    // ë‹¤ìŒ ë²„íŠ¼ - Safari í˜¸í™˜ì„± ê°œì„ 
    function goToNextStep(e) {
      if (e) e.preventDefault();
      
      console.log('Next button clicked');
      console.log('Button disabled:', nextBtn.disabled);
      console.log('myPhoto:', myPhoto ? 'exists (' + Math.round(myPhoto.length/1024) + 'KB)' : 'null');
      console.log('actorPhoto:', actorPhoto ? 'exists (' + Math.round(actorPhoto.length/1024) + 'KB)' : 'null');
      
      if (nextBtn.disabled) {
        console.log('Button is disabled, checking why...');
        if (!myPhoto) alert('ë‚´ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
        else if (!actorPhoto) alert('í•¨ê»˜í•  ì‚¬ëŒ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
        else if (!consent1.checked) alert('ì²« ë²ˆì§¸ ë™ì˜ì‚¬í•­ì„ ì²´í¬í•´ì£¼ì„¸ìš”.');
        else if (!consent2.checked) alert('ë‘ ë²ˆì§¸ ë™ì˜ì‚¬í•­ì„ ì²´í¬í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      try {
        // sessionStorage ì €ì¥ ì‹œë„
        sessionStorage.setItem('myPhoto', myPhoto);
        sessionStorage.setItem('actorPhoto', actorPhoto);
        console.log('Photos saved to sessionStorage');
        
        // í˜ì´ì§€ ì´ë™
        window.location.href = 'select.html';
      } catch (error) {
        console.error('Storage error:', error);
        
        // Safari Private Browsing ë˜ëŠ” ìš©ëŸ‰ ì´ˆê³¼
        if (error.name === 'QuotaExceededError' || error.message.includes('quota')) {
          alert('ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ë¹„ìš°ê±°ë‚˜ ì¼ë°˜ ëª¨ë“œë¡œ ì´ìš©í•´ì£¼ì„¸ìš”.');
        } else {
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }
    }

    // clickê³¼ touchend ëª¨ë‘ ì§€ì› (ëª¨ë°”ì¼ Safari í˜¸í™˜)
    nextBtn.addEventListener('click', goToNextStep);
    nextBtn.addEventListener('touchend', (e) => {
      e.preventDefault();
      goToNextStep(e);
    });
  </script>
</body>
</html>
