## 0) 확장 전략 한 줄

* **핵심은 “시드(Seed) 10~15개”를 두고**
* 나머지는 **Stage 레이어(앵커/소품/갈등) × Genre 레이어(연출 문법) × 구조 레이어(Quick/Story/Trailer 비트)**를 조합해 자동 생성
* 마지막에 **중복 제거(해시) + 안전/IP 필터 + 분포 밸런싱**으로 60/60/20을 “맞춰” 생성

---

## 1) 데이터 테이블 (확장용 재료)

### 1-1. Stage 레이어 테이블

| stage           | anchors(장소)                                                                | props(소품)                                              | safe_conflicts(갈등/사건)                                                            | endings(엔딩 톤)                                                   |
| --------------- | -------------------------------------------------------------------------- | ------------------------------------------------------ | -------------------------------------------------------------------------------- | --------------------------------------------------------------- |
| teen            | classroom, hallway, festival_stage, rainy_walk, sports_day                 | notebook, test_paper, mic, trophy, school_bell         | presentation_mess, misunderstanding, lost_item, small_rivalry, surprise_task     | unexpected_applause, friend_support, self_laugh, new_try        |
| twenties        | interview_room, elevator_mirror, night_bus, tiny_studio, convenience_store | resume, badge, laptop, coffee, street_lights           | deadline, awkward_meeting, tiny_mistake, small_win, missed_alarm                 | one_step_forward, comic_relief, calm_acceptance, new_choice     |
| newlywed        | new_apartment, kitchen, moving_boxes, laundry_day, weekend_outing          | boxes, dishes, memo_note, calendar, small_gift         | housework_mismatch, cooking_fail, budget_day, tiny_argument, surprise_event      | hand_hold, laugh_together, warm_makeup, cozy_home               |
| early_parenting | dawn_kitchen, toy_livingroom, stroller_walk, generic_clinic, night_lullaby | bottle, stroller, tiny_socks, diaper_bag, sticky_notes | sleepy_chaos, missing_item, schedule_panic, tiny_scare_then_relief, teamwork_day | morning_light, small_victory, gentle_hug_silhouette, calm_reset |

> 주의: newlywed/early_parenting은 **partner/baby face는 기본 “silhouette/hand/blur depth-of-field” 규칙을 항상 포함**.

---

### 1-2. Genre 연출 레이어(카메라/색감/자막)

| genre   | camera_style                            | color_mood       | edit_pace   | caption_style                     |
| ------- | --------------------------------------- | ---------------- | ----------- | --------------------------------- |
| docu    | handheld, observational, interview-like | neutral, natural | medium      | date/location lower-third + 담백 문장 |
| comedy  | snappy cuts, reaction shots             | bright           | fast        | 짧고 강한 펀치라인                        |
| drama   | steady cinematic, close emotions        | warm/soft        | medium-slow | 짧은 감정 문장                          |
| melo    | slow push-in, close-up                  | pastel           | slow        | 감성 한 줄(편지 톤)                      |
| fantasy | wide wonder, mystical moves             | dreamy           | medium      | 신비로운 타이틀+짧은 문장                    |

---

### 1-3. Quick(8×3) 구조 레이어

Quick은 클립 3개가 **하나의 미니 구조**를 가져야 해.

* Hook: “상황+긴장/기대”
* Main: “갈등/해프닝”
* Ending: “반전/회복/웃음/여운”

**Quick용 Hook/Main/Ending 문장 프레임(캡션)**

* Hook 캡션 후보: `하필 오늘…`, `잠깐만… 뭐지?`, `이 순간이 시작이었다`
* Main 캡션 후보: `망했다`, `큰일 났다`, `내가 왜 그랬지`
* Ending 캡션 후보: `근데… 의외로`, `그래도 괜찮아`, `다음엔 더 잘할 거야`

---

### 1-4. Story(15×3) 구조 레이어(클립당 비트 3개)

Story는 **각 클립(15초)** 안에 3비트:

1. setup(상황) → 2) tension(감정/갈등) → 3) turn(전환)

Story는 3클립이 합쳐져 전체 3막:

* Clip1: 시작/예고
* Clip2: 사건/피크
* Clip3: 회복/결말(Rewrite 적용 시 여기 교체)

---

### 1-5. Trailer(45~60×1) 구조 레이어(장면 6~10개)

Trailer는 장면을 **카드**처럼 조립:

1. Title card (오리지널 타이틀)
2. Intro(일상)
3. Trigger(전환점)
4. Escalation(확대)
5. Moment(감정 핵심)
6. Rewrite insertion(옵션, 1장면)
7. Resolve(결말)
8. End card (Fiction/Simulation)

---

## 2) 자동 확장 규칙 (조합 + 제약)

### 2-1. 조합 규칙(핵심)

* 템플릿 1개 생성 시:

  1. stage 선택
  2. genre 선택
  3. mode 선택(quick/story/trailer)
  4. stage 앵커/소품/갈등을 “서로 충돌 없게” 샘플링
  5. genre 연출 레이어를 scene.camera/color/edit/caption에 덧씌움

### 2-2. 제약 규칙(중요)

* **IP 필터**: 고유명사/작품명/캐릭터명/브랜드/로고 단어가 캡션/scene에 들어가면 즉시 치환 또는 폐기
* **가족 얼굴 규칙**: newlywed/early_parenting은 항상 `family_face_rule: silhouette` 포함
* **민감 장면 제한**: 폭력/자해/학대/성적 요소 직접 묘사 금지(템플릿 레벨에서 아예 재료를 넣지 않기)
* **중복 방지**: 아래 “템플릿 시그니처”로 해시 생성해 유사 중복 제거

### 2-3. 템플릿 시그니처(해시 키)

* Quick: `stage|genre|hook_anchor|main_conflict|ending_type|caption_pattern_id`
* Story: `stage|genre|clip1_anchor|clip2_conflict|clip3_ending|beat_pattern_id`
* Trailer: `stage|genre|trigger_conflict|moment_anchor|ending_type|scene_count`

---

## 3) 분포(밸런싱) 규칙

목표 개수:

* Quick 60: stage 4개 × genre 5개 = 20조합 → **조합당 3개씩** 만들면 딱 60
* Story 60: 똑같이 조합당 3개씩
* Trailer 20: 조합 20개 → **조합당 1개씩** 만들면 딱 20

즉 MVP 라이브러리 목표:

* `for each (stage, genre): quick 3 + story 3 + trailer 1`

---

## 4) 코드: 템플릿 자동 생성기 (Python)

> 이 코드는 “생성 규칙”을 구현한 최소 버전이야. 실제 서비스에선 DB 저장만 붙이면 끝.

```python
import random
import hashlib
from dataclasses import dataclass, asdict
from typing import Dict, List, Tuple

STAGES = {
  "teen": {
    "anchors": ["classroom","hallway","festival_stage","rainy_walk","sports_day"],
    "props": ["notebook","test_paper","mic","trophy","school_bell"],
    "conflicts": ["presentation_mess","misunderstanding","lost_item","small_rivalry","surprise_task"],
    "endings": ["unexpected_applause","friend_support","self_laugh","new_try"],
    "family_rule": None
  },
  "twenties": {
    "anchors": ["interview_room","elevator_mirror","night_bus","tiny_studio","convenience_store"],
    "props": ["resume","badge","laptop","coffee","street_lights"],
    "conflicts": ["deadline","awkward_meeting","tiny_mistake","small_win","missed_alarm"],
    "endings": ["one_step_forward","comic_relief","calm_acceptance","new_choice"],
    "family_rule": None
  },
  "newlywed": {
    "anchors": ["new_apartment","kitchen","moving_boxes","laundry_day","weekend_outing"],
    "props": ["boxes","dishes","memo_note","calendar","small_gift"],
    "conflicts": ["housework_mismatch","cooking_fail","budget_day","tiny_argument","surprise_event"],
    "endings": ["hand_hold","laugh_together","warm_makeup","cozy_home"],
    "family_rule": "partner_silhouette"
  },
  "early_parenting": {
    "anchors": ["dawn_kitchen","toy_livingroom","stroller_walk","generic_clinic","night_lullaby"],
    "props": ["bottle","stroller","tiny_socks","diaper_bag","sticky_notes"],
    "conflicts": ["sleepy_chaos","missing_item","schedule_panic","tiny_scare_then_relief","teamwork_day"],
    "endings": ["morning_light","small_victory","gentle_hug_silhouette","calm_reset"],
    "family_rule": "baby_no_detail"
  },
}

GENRES = {
  "docu":   {"camera":"handheld, observational", "color":"natural", "pace":"medium", "caption":"lower-third + plain"},
  "comedy": {"camera":"snappy cuts, reaction shots", "color":"bright", "pace":"fast", "caption":"punchline"},
  "drama":  {"camera":"steady cinematic, close emotion", "color":"warm", "pace":"medium-slow", "caption":"emotional"},
  "melo":   {"camera":"slow push-in, close-up", "color":"pastel", "pace":"slow", "caption":"letter-like"},
  "fantasy":{"camera":"wide wonder shots", "color":"dreamy", "pace":"medium", "caption":"mystical"}
}

HOOK_CAPS = ["하필 오늘…", "잠깐만… 뭐지?", "이 순간이 시작이었다", "괜찮아, 심호흡"]
MAIN_CAPS = ["망했다", "큰일 났다", "내가 왜 그랬지", "잠깐만… 다시"]
END_CAPS  = ["근데… 의외로", "그래도 괜찮아", "다음엔 더 잘할 거야", "이상하게 웃음이 났다"]

def sig_hash(s: str) -> str:
    return hashlib.sha256(s.encode("utf-8")).hexdigest()[:12]

def ip_safe(text: str) -> bool:
    # MVP용: 고유명사 필터는 실제론 사전/룰/LLM로 강화
    banned = ["해리포터","마블","디즈니","넷플릭스","지브리","나루토","원피스"]
    return all(b not in text for b in banned)

def build_quick(stage: str, genre: str, variant: int) -> Dict:
    st, gn = STAGES[stage], GENRES[genre]
    hook_anchor = random.choice(st["anchors"])
    main_conflict = random.choice(st["conflicts"])
    ending_type = random.choice(st["endings"])

    hook_cap = HOOK_CAPS[(variant + random.randint(0,10)) % len(HOOK_CAPS)]
    main_cap = MAIN_CAPS[(variant + random.randint(0,10)) % len(MAIN_CAPS)]
    end_cap  = END_CAPS[(variant + random.randint(0,10)) % len(END_CAPS)]

    if not all(ip_safe(c) for c in [hook_cap, main_cap, end_cap]):
        raise ValueError("IP unsafe caption")

    clips = [
      {"clip_no":1,"role":"hook","duration_sec":8,
       "scene":{"location":hook_anchor,"time":"daytime","action":"setup moment","emotion":"anticipation",
               "camera":gn["camera"],"visual_rules":["no logos","no famous IP","no real names"]},
       "caption":hook_cap},
      {"clip_no":2,"role":"main","duration_sec":8,
       "scene":{"location":hook_anchor,"time":"same day","action":f"conflict: {main_conflict}","emotion":"chaos",
               "camera":gn["camera"],"visual_rules":["no logos","no famous IP","no real names"]},
       "caption":main_cap},
      {"clip_no":3,"role":"ending","duration_sec":8,
       "scene":{"location":hook_anchor,"time":"after","action":f"resolve: {ending_type}","emotion":"relief",
               "camera":gn["camera"],"visual_rules":["no logos","no famous IP","no real names"]},
       "caption":end_cap},
    ]

    if st["family_rule"]:
        for c in clips:
            c["scene"]["visual_rules"].append(st["family_rule"])

    signature = f"{stage}|{genre}|{hook_anchor}|{main_conflict}|{ending_type}|Q{variant}"
    return {"mode":"quick","format":"vertical_9_16","stage":stage,"genre":genre,
            "sliders":{"realism":0.6,"intensity":0.4,"pace":0.7},
            "clips":clips,"signature":sig_hash(signature)}

def build_story(stage: str, genre: str, variant: int) -> Dict:
    st, gn = STAGES[stage], GENRES[genre]
    a1, a2 = random.sample(st["anchors"], 2)
    c2 = random.choice(st["conflicts"])
    end = random.choice(st["endings"])

    # 비트 패턴 3개를 문자열로만 두고, 실제론 action에 더 구체화 가능
    def clip(clip_no, role, anchor, focus):
        return {"clip_no":clip_no,"role":role,"duration_sec":15,
                "scene":{"location":anchor,"time":"varies",
                        "action":f"beat1 setup → beat2 tension → beat3 turn ({focus})",
                        "emotion":"mixed",
                        "camera":gn["camera"],
                        "visual_rules":["no logos","no famous IP","no real names"]},
                "caption":random.choice(HOOK_CAPS if role=="hook" else MAIN_CAPS if role=="main" else END_CAPS)}

    clips = [
        clip(1,"hook",a1,"start"),
        clip(2,"main",a2,f"conflict: {c2}"),
        clip(3,"ending",a1,f"ending: {end}"),
    ]
    if st["family_rule"]:
        for c in clips:
            c["scene"]["visual_rules"].append(st["family_rule"])

    signature = f"{stage}|{genre}|{a1}|{a2}|{c2}|{end}|S{variant}"
    return {"mode":"story","format":"vertical_9_16","stage":stage,"genre":genre,
            "sliders":{"realism":0.6,"intensity":0.4,"pace":0.7},
            "clips":clips,"signature":sig_hash(signature)}

def build_trailer(stage: str, genre: str) -> Dict:
    st, gn = STAGES[stage], GENRES[genre]
    trigger = random.choice(st["conflicts"])
    moment = random.choice(st["anchors"])
    end = random.choice(st["endings"])
    scene_count = random.choice([6,7,8,9,10])

    scenes = []
    scenes.append({"clip_no":1,"role":"trailer_scene","duration_sec":5,
                   "title_card":"ORIGINAL TITLE","scene":{"location":"title_card","time":"", "action":"title","emotion":"",
                   "camera":"static","visual_rules":["fiction/simulation"]},"caption":""})

    for i in range(2, scene_count):
        loc = random.choice(st["anchors"])
        action = "intro/day-in-life" if i < 4 else (f"trigger: {trigger}" if i == 4 else f"moment: {loc}")
        scenes.append({"clip_no":i,"role":"trailer_scene","duration_sec":6,
                       "scene":{"location":loc,"time":"varies","action":action,"emotion":"rising",
                               "camera":gn["camera"],"visual_rules":["no logos","no famous IP","no real names"]},
                       "caption":""})

    scenes.append({"clip_no":scene_count,"role":"trailer_scene","duration_sec":6,
                   "scene":{"location":moment,"time":"after","action":f"resolve: {end}","emotion":"release",
                           "camera":gn["camera"],"visual_rules":["no logos","no famous IP","no real names"]},
                   "caption":""})

    if st["family_rule"]:
        for s in scenes:
            if "scene" in s and "visual_rules" in s["scene"]:
                s["scene"]["visual_rules"].append(st["family_rule"])

    signature = f"{stage}|{genre}|{trigger}|{moment}|{end}|T{scene_count}"
    return {"mode":"trailer","format":"vertical_9_16","stage":stage,"genre":genre,
            "sliders":{"realism":0.6,"intensity":0.4,"pace":0.7},
            "clips":scenes,"signature":sig_hash(signature)}

def generate_library() -> Tuple[List[Dict], List[Dict], List[Dict]]:
    quick, story, trailer = [], [], []
    seen = set()

    # 목표 분포: (stage,genre)당 quick 3 + story 3 + trailer 1
    for stage in STAGES:
        for genre in GENRES:
            # Quick 3
            v = 0
            while len([t for t in quick if t["stage"]==stage and t["genre"]==genre]) < 3:
                t = build_quick(stage, genre, v); v += 1
                if t["signature"] in seen: continue
                seen.add(t["signature"]); quick.append(t)

            # Story 3
            v = 0
            while len([t for t in story if t["stage"]==stage and t["genre"]==genre]) < 3:
                t = build_story(stage, genre, v); v += 1
                if t["signature"] in seen: continue
                seen.add(t["signature"]); story.append(t)

            # Trailer 1
            while len([t for t in trailer if t["stage"]==stage and t["genre"]==genre]) < 1:
                t = build_trailer(stage, genre)
                if t["signature"] in seen: continue
                seen.add(t["signature"]); trailer.append(t)

    # 검증
    assert len(quick) == 60, len(quick)
    assert len(story) == 60, len(story)
    assert len(trailer) == 20, len(trailer)
    return quick, story, trailer

if __name__ == "__main__":
    q, s, t = generate_library()
    print("OK", len(q), len(s), len(t))
```

---

## 5) “코드/테이블”로 끝내기: 운영형 확장 룰 추가

### 5-1. 템플릿 확장 레벨(추천)

* **L1(조합)**: anchors/conflicts/endings만 섞기 (가장 안전)
* **L2(문장 변주)**: 캡션/액션 문장 패턴 3~5개씩 추가
* **L3(촬영 문법 변주)**: genre camera를 2~3개 variant로 확장(예: docu=handheld/interview/archival)
* **L4(슬라이더 반영)**: pace/intensity에 따라 컷 수/캡션 길이/액션 강도 자동 변경

### 5-2. 슬라이더 반영 룰(예시)

* pace ↑ : `snappy cuts`, action을 더 “연속 동작”으로, 캡션은 더 짧게
* intensity ↑ : 갈등을 “작지만 선명하게”, 단 공포/폭력은 금지
* realism ↑ : fantasy 요소 줄이고 소품/장소를 현실적으로

